{% extends "base.html" %}
{% block title %}Checkout — Forge Commerce{% endblock %}
{% block content %}
<div class="page-header">
    <h1>Checkout</h1>
</div>

<div class="checkout-steps">
    <span class="step {% if step == 'shipping' %}active{% endif %}">1. Shipping</span>
    <span class="step {% if step == 'payment' %}active{% endif %}">2. Payment</span>
    <span class="step {% if step == 'review' %}active{% endif %}">3. Review</span>
    <span class="step {% if step == 'confirmation' %}active{% endif %}">4. Done</span>
</div>

{% if error and error != "" %}
<div class="alert alert-error">{{ error }}</div>
{% endif %}

{% if step == "shipping" %}
<div class="checkout-form">
    <h2>Shipping Information</h2>
    {% if addresses | length > 0 %}
    <div class="saved-addresses">
        <h3>Saved Addresses</h3>
        {% for addr in addresses %}
        <div class="address-card">
            <p><strong>{{ addr.name }}</strong></p>
            <p>{{ addr.address }}, {{ addr.city }} {{ addr.zip }}</p>
            <form method="POST" action="/checkout/shipping">
                <input type="hidden" name="name" value="{{ addr.name }}">
                <input type="hidden" name="address" value="{{ addr.address }}">
                <input type="hidden" name="city" value="{{ addr.city }}">
                <input type="hidden" name="zip" value="{{ addr.zip }}">
                <button type="submit" class="btn btn-sm">Use This Address</button>
            </form>
        </div>
        {% endfor %}
    </div>
    <hr>
    {% endif %}
    <form method="POST" action="/checkout/shipping">
        <div class="form-group">
            <label for="name">Full Name</label>
            <input type="text" id="name" name="name" required>
        </div>
        <div class="form-group">
            <label for="address">Address</label>
            <input type="text" id="address" name="address" required>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="city">City</label>
                <input type="text" id="city" name="city" required>
            </div>
            <div class="form-group">
                <label for="zip">ZIP Code</label>
                <input type="text" id="zip" name="zip" required>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Continue to Payment</button>
    </form>
</div>

{% elif step == "payment" %}
<div class="checkout-form">
    <h2>Payment Information</h2>
    <form method="POST" action="/checkout/payment">
        <input type="hidden" name="shipping_name" value="{{ shipping.name }}">
        <input type="hidden" name="shipping_address" value="{{ shipping.address }}">
        <input type="hidden" name="shipping_city" value="{{ shipping.city }}">
        <input type="hidden" name="shipping_zip" value="{{ shipping.zip }}">
        <div class="form-group">
            <label for="card_number">Card Number</label>
            <input type="text" id="card_number" name="card_number" placeholder="4242 4242 4242 4242" required>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="expiry">Expiry</label>
                <input type="text" id="expiry" name="expiry" placeholder="MM/YY" required>
            </div>
            <div class="form-group">
                <label for="cvv">CVV</label>
                <input type="text" id="cvv" name="cvv" placeholder="123" required>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Review Order</button>
    </form>
</div>

{% elif step == "review" %}
<div class="checkout-form">
    <h2>Review Your Order</h2>
    <div class="review-section">
        <h3>Shipping</h3>
        <p>{{ shipping.name }}<br>{{ shipping.address }}<br>{{ shipping.city }} {{ shipping.zip }}</p>
    </div>
    <div class="review-section">
        <h3>Payment</h3>
        <p>Card ending in {{ card_last_four }}</p>
    </div>
    <div class="review-section">
        <h3>Items</h3>
        {% for item in items %}
        <div class="review-item">
            <span>{{ item.product_name }} × {{ item.quantity }}</span>
            <span>${{ (item.price * item.quantity) | round(precision=2) }}</span>
        </div>
        {% endfor %}
        <div class="review-total">
            <strong>Total: ${{ total | round(precision=2) }}</strong>
        </div>
    </div>
    <form method="POST" action="/checkout/confirm">
        <input type="hidden" name="shipping_name" value="{{ shipping.name }}">
        <input type="hidden" name="shipping_address" value="{{ shipping.address }}">
        <input type="hidden" name="shipping_city" value="{{ shipping.city }}">
        <input type="hidden" name="shipping_zip" value="{{ shipping.zip }}">
        <button type="submit" class="btn btn-primary btn-lg">Place Order</button>
    </form>
</div>

{% elif step == "confirmation" %}
<div class="checkout-confirmation">
    <div class="confirmation-icon">✓</div>
    <h2>Order Placed!</h2>
    <p>Thank you for your order. Your order ID is:</p>
    <p class="order-id">{{ order.id }}</p>
    <div class="confirmation-actions">
        <a href="/profile" class="btn btn-primary">View Orders</a>
        <a href="/products" class="btn">Continue Shopping</a>
    </div>
</div>
{% endif %}
{% endblock %}
